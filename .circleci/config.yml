version: 2.1

orbs:
  heroku: circleci/heroku@1.2.6
  slack: circleci/slack@4.4.4
  cypress: cypress-io/cypress@1
executors:
  with-chrome:
    resource_class: medium
    docker:
      - image: "cypress/browsers:node16.13.0-chrome95-ff94"
workflows:
  build:
    jobs:
      - cypress/install:
          yarn: true
          executor: with-chrome
          build: yarn install
          filters:
            branches:
              only:
                - master
                - dev
                - testing
      - cypress/run:
          name: cypress-staging
          requires:
            - cypress/install
          context:
            - Slack
            - Staging
          filters:
            branches:
              only:
                - testing
                - dev
          record: true
          no-workspace: true
          yarn: true
          executor: with-chrome
          config-file: staging-config.json
          tags: 'staging'
          parallel: true
          parallelism: 3
          spec: cypress/integration/0-auth/*
          post-steps:
            - slack/notify:
                branch_pattern: 'dev,testing'
                mentions: '@Chisom'
                template: basic_success_1
                event: pass
            - slack/notify:
                branch_pattern: 'dev,testing'
                mentions: '@Chisom'
                template: basic_fail_1
                event: fail
      - cypress/run:
          name: cypress-production
          requires:
            - cypress/install
          context:
            - Slack
            - Production
          filters:
            branches:
              only:
                - master
          no-workspace: true
          yarn: true
          executor: with-chrome
          config-file: production-config.json
          tags: 'production'
          store_artifacts: true
          parallel: true
          parallelism: 3
          post-steps:
            - slack/notify:
                branch_pattern: master
                mentions: '@Chisom'
                template: basic_success_1
                event: pass
            - slack/notify:
                branch_pattern: master
                mentions: '@Chisom'
                template: basic_fail_1
                event: fail
      - heroku/deploy-via-git:
          requires:
            - cypress-staging
          context:
            - Staging
          filters:
            branches:
              only:
                - dev
      - heroku/deploy-via-git:
          requires:
            - cypress-production
          context:
            - Production
          filters:
            branches:
              only:
                - master