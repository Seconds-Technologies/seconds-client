version: 2.1

orbs:
  slack: circleci/slack@4.4.4
  cypress: cypress-io/cypress@1
executors:
  with-chrome:
    resource_class: medium
    docker:
      - image: "cypress/browsers:node16.13.0-chrome95-ff94"
    environment:
      API_KEY: h5tUvrDlLvIBQ3A72Nh2SNA6
workflows:
  build:
    jobs:
      - cypress/install:
          yarn: true
          executor: with-chrome
          build: yarn install
          filters:
            branches:
              only:
                - master
                - dev
                - testing
      - cypress/run:
          requires:
            - cypress/install
          context:
            - Slack
          filters:
            branches:
              only:
                - testing
                - dev
          no-workspace: true
          yarn: true
          executor: with-chrome
          config-file: staging-config.json
          tags: 'staging'
          store_artifacts: true
          parallel: true
          parallelism: 3
          post-steps:
            - slack/notify:
                branch_pattern: 'dev,testing'
                mentions: '@Chisom'
                template: basic_success_1
                event: pass
            - slack/notify:
                branch_pattern: 'dev,testing'
                mentions: '@Chisom'
                template: basic_fail_1
                event: fail
      - cypress/run:
          requires:
            - cypress/install
          context:
            - Slack
          no-workspace: true
          yarn: true
          executor: with-chrome
          config-file: production-config.json
          tags: 'production'
          store_artifacts: true
          parallel: true
          parallelism: 3
          filters:
            branches:
              only:
                - master
          post-steps:
            - slack/notify:
                branch_pattern: master
                mentions: '@Chisom'
                template: basic_success_1
                event: pass
            - slack/notify:
                branch_pattern: master
                mentions: '@Chisom'
                template: basic_fail_1
                event: fail